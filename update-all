#!/bin/bash

# ====== config ======
SCRIPT_DIR="/opt/cra2"
MODULES_DIR="$SCRIPT_DIR/modules"
source "$MODULES_DIR/colors.sh"
source "$MODULES_DIR/logger.sh"
source "$MODULES_DIR/config.sh"
source "$MODULES_DIR/platform.sh"
source "$MODULES_DIR/git.sh"

# ====== flags ======
PULL_ONLY=false
DRY_RUN=false

for arg in "$@"; do
  case "$arg" in
    --pull-only) PULL_ONLY=true ;;
    --dry-run) DRY_RUN=true ;;
    *) echo "Unknown flag: $arg" && exit 1 ;;
  esac
done

# ====== files ======
LIST_FILE="$HOME/.repo-autosync.list"
LOG_FILE="$HOME/.create-repo.log"
ERROR_LOG="$HOME/.create-repo-errors.log"

# ====== check list file ======
if [ ! -f "$LIST_FILE" ]; then
  echo "No repos tracked. Use create-repo to start tracking."
  exit 0
fi

# ====== start sync ======
echo -e "${BOLD}üîÑ Starting sync of tracked repositories...${RESET}"
while IFS= read -r repo_path || [[ -n "$repo_path" ]]; do
  [ -z "$repo_path" ] && continue
  [ ! -d "$repo_path/.git" ] && echo "‚ùå Not a Git repo: $repo_path" && continue

  cd "$repo_path" || continue
  PROJECT_NAME=$(basename "$repo_path")
  BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)

  # ===== local config =====
  LOCAL_CONF="$repo_path/.create-repo.local.conf"
  if [ -f "$LOCAL_CONF" ]; then
    source "$LOCAL_CONF"
    if [ "$disable_sync" == "true" ]; then
      echo -e "üö´ $PROJECT_NAME skipped (disabled via local config)"
      continue
    fi
  fi

  echo -e "\nüìÅ $PROJECT_NAME ($BRANCH)"

  # ===== pull =====
  git pull origin "$BRANCH"
  PULL_STATUS=$?

  if [ "$PULL_ONLY" = true ]; then
    echo -e "üîÑ pull-only mode. Push skipped."
    continue
  fi

  if [ "$DRY_RUN" = true ]; then
    echo -e "üß™ dry-run mode. Simulating push..."
    git status
    continue
  fi

  # ===== push =====
  git push origin "$BRANCH"
  PUSH_STATUS=$?

  # ===== result logging =====
  if [ "$PULL_STATUS" -eq 0 ] && [ "$PUSH_STATUS" -eq 0 ]; then
    log_success "$PROJECT_NAME" "$repo_path"
    echo -e "‚úÖ Synced successfully"
  else
    log_error "$PROJECT_NAME" "$repo_path"
    echo -e "‚ùå Sync failed"
  fi

done < "$LIST_FILE"
