#!/bin/bash
set -euxo pipefail
trap 'echo "âŒ ERROR at line $LINENO (exit code $?)" >&2' ERR

SCRIPT_VERSION="{{VERSION}}"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
echo "â„¹ï¸ SCRIPT_DIR: $SCRIPT_DIR"

# Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ¿ÑƒÑ‚ĞµĞ¹ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
export PLATFORM_MAP="${PLATFORM_MAP:-$HOME/.create-repo.platforms}"
export LOG_FILE="${LOG_FILE:-$HOME/.create-repo.log}"
export REPO_LIST="${REPO_LIST:-$HOME/.repo-autosync.list}"

# ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¾Ğ´ÑƒĞ»ĞµĞ¹
for file in colors flags version update help config platform repo logger doctor; do
  mod="$SCRIPT_DIR/modules/$file.sh"
  if [[ ! -f "$mod" ]]; then
    echo "âŒ Module not found: $mod"
    exit 1
  fi
  echo "ğŸ”— Loading module: $file.sh"
  source "$mod"
done

main() {
  echo "ğŸš€ Running create-repo"

  validate_flags "$@"

  repo=""
  platform_flag=""
  interactive=false
  dry_run=false

  # ĞÑ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹
  while [[ $# -gt 0 ]]; do
    case $1 in
      --help|-h) show_help; exit 0 ;;
      --version) show_version; exit 0 ;;
      --update) check_for_update; exit 0 ;;
      --interactive) interactive=true ;;
      --platform=*) platform_flag="${1#*=}" ;;
      --platform-status) show_platform_bindings; exit 0 ;;
      --status) print_status_all; exit 0 ;;
      --log)
        if [[ "$2" == "--errors" ]]; then
          tail -n 20 "$HOME/.create-repo-errors.log"; exit 0
        fi
        tail -n 20 "$LOG_FILE"; exit 0 ;;
      --list) print_repo_list; exit 0 ;;
      --remove)
        if [[ "$2" == "--force" ]]; then
          remove_repo_force "$(pwd)"; exit 0
        fi ;;
      --pull-only) perform_pull_only; exit 0 ;;
      --dry-run) export NO_PUSH=true; dry_run=true ;;
      --sync-now) sync_now; exit 0 ;;
      --doctor) doctor_check; exit 0 ;;
      *) [[ -z "$repo" ]] && repo=$1 ;;
    esac
    shift
  done

  export dry_run="${dry_run:-false}"

  CURRENT_FOLDER="$(realpath "$PWD")"
  echo "ğŸ“ Current folder: $CURRENT_FOLDER"

  load_config

  echo "ğŸ§ª dry_run=$dry_run"
  echo "ğŸ§ª platform_flag=$platform_flag"

  # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ñ‹
  platform="$(detect_platform "$CURRENT_FOLDER" "$platform_flag" "$dry_run")"
  echo "ğŸ“¦ Detected platform: $platform"

  [[ -z "$platform" ]] && platform="unknown"

  if [[ "$platform" == "unknown" ]]; then
    if [[ "$dry_run" == "true" ]]; then
      echo -e "${YELLOW}âš ï¸ Platform is unknown, continuing due to dry-run.${RESET}"
    else
      echo -e "${RED}âŒ No Git platform detected.${RESET}"
      echo "ğŸ“ Folder: $CURRENT_FOLDER"
      echo "ğŸ“„ PLATFORM_MAP:"
      cat "$PLATFORM_MAP" 2>/dev/null || echo "(not found)"
      echo "ğŸ§ª platform_flag=$platform_flag"
      exit 1
    fi
  fi

  # ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹
  repo=${repo:-$(basename "$PWD")}
  branch=${default_branch:-main}
  visibility=${default_visibility:-public}

  echo "ğŸ“Œ Repo: $repo"
  echo "ğŸ“Œ Branch: $branch"
  echo "ğŸ“Œ Visibility: $visibility"

  # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹
  generate_readme
  generate_gitignore
  git_init_repo "$repo" "$branch" "$platform" "$visibility" "$(date '+%Y-%m-%d %H:%M:%S')" "$LOG_FILE" "$REPO_LIST"
  show_final_message "$repo" "$branch" "$PWD" "$REPO_LIST" "$platform"

  if [[ "$dry_run" == "true" ]]; then
    echo -e "${YELLOW}This was a dry-run. No git push was executed.${RESET}"
  fi
}

main "$@"
