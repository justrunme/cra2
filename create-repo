#!/bin/bash
set -e
set -x
trap 'echo "❌ FAILED at line $LINENO with exit code $?"' ERR

echo "STEP 0: Start create-repo"

SCRIPT_VERSION="{{VERSION}}"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
echo "STEP 1: SCRIPT_DIR = $SCRIPT_DIR"

# Установка переменных окружения
export PLATFORM_MAP="${PLATFORM_MAP:-$HOME/.create-repo.platforms}"
export LOG_FILE="${LOG_FILE:-$HOME/.create-repo.log}"
export REPO_LIST="${REPO_LIST:-$HOME/.repo-autosync.list}"

echo "STEP 2: PLATFORM_MAP = $PLATFORM_MAP"
echo "STEP 3: LOG_FILE = $LOG_FILE"
echo "STEP 4: REPO_LIST = $REPO_LIST"

# Подключаем модули
for file in colors flags version update help config platform repo logger doctor; do
  full="$SCRIPT_DIR/modules/$file.sh"
  echo "STEP 5: Trying to load $full"
  if [[ ! -f "$full" ]]; then
    echo "❌ Missing module: $full"
    exit 1
  fi
  source "$full"
  echo "STEP 6: Loaded $file.sh"
done

echo "STEP 7: All modules loaded. Now calling main()"

main() {
  echo "STEP 8: Inside main()"
  echo "Arguments: $@"
  echo "Exiting with success just for test"
  exit 0
}

main "$@"
