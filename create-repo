#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π
source "$SCRIPT_DIR/modules/colors.sh"
source "$SCRIPT_DIR/modules/flags.sh"
source "$SCRIPT_DIR/modules/version.sh"
source "$SCRIPT_DIR/modules/update.sh"
source "$SCRIPT_DIR/modules/help.sh"
source "$SCRIPT_DIR/modules/config.sh"
source "$SCRIPT_DIR/modules/platform.sh"
source "$SCRIPT_DIR/modules/repo.sh"
source "$SCRIPT_DIR/modules/logger.sh"
source "$SCRIPT_DIR/modules/doctor.sh"

# üèÅ –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
  validate_flags "$@"

  repo=""
  platform_flag=""
  interactive=false

  while [[ $# -gt 0 ]]; do
    case $1 in
      --help|-h) show_help; exit 0 ;;
      --version) show_version; exit 0 ;;
      --update) check_for_update; exit 0 ;;
      --interactive) interactive=true ;;
      --platform=*) platform_flag="${1#*=}" ;;
      --platform-status) show_platform_bindings; exit 0 ;;
      --status) print_status_all; exit 0 ;;
      --log)
        if [[ "$2" == "--errors" ]]; then
          tail -n 10 "$HOME/.create-repo-errors.log"
          exit 0
        fi
        tail -n 10 "$HOME/.create-repo.log"
        exit 0
        ;;
      --list) print_repo_list; exit 0 ;;
      --remove)
        if [[ "$2" == "--force" ]]; then
          remove_repo_force "$(pwd)"
          exit 0
        fi
        ;;
      --pull-only) perform_pull_only; exit 0 ;;
      --dry-run) perform_dry_run; exit 0 ;;
      --sync-now) sync_now; exit 0 ;;
      --doctor) doctor_check; exit 0 ;;
      *) [[ -z "$repo" ]] && repo=$1 ;;
    esac
    shift
  done

  CURRENT_FOLDER=$(realpath "$PWD")
  load_config

  # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
  platform=$(detect_platform "$CURRENT_FOLDER" "$platform_flag")
  [[ -z "$platform" ]] && echo -e "${RED}‚ùå No Git platform detected.${RESET}" && exit 1

  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  repo=${repo:-$(basename "$PWD")}
  branch=${default_branch:-main}
  visibility=${default_visibility:-public}

  # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è README –∏ .gitignore –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
  generate_readme
  generate_gitignore

  git_init_repo "$repo" "$branch" "$platform" "$visibility" "$(date '+%Y-%m-%d %H:%M:%S')" "$LOG_FILE" "$REPO_LIST"
  show_final_message "$repo" "$branch" "$PWD" "$REPO_LIST" "$platform"
}

main "$@"
