#!/bin/bash
set -e
set -x

echo "üß™ Testing double tracking corner case..."

BIN="${CREATE_REPO_BIN:-./create-repo}"
TMP_DIR=$(mktemp -d)
cd "$TMP_DIR"
echo "üìÅ TMP_DIR: $TMP_DIR"

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Git
git init -b main &>/dev/null
git config user.email "ci@example.com"
git config user.name "CI User"
echo "# Double tracking test" > README.md
git add README.md
git commit -m "init" &>/dev/null

# –î–æ–±–∞–≤–∏–º —Ñ–µ–π–∫–æ–≤—ã–π remote
git remote add origin https://example.com/fake.git

# –ó–∞–ø—É—Å–∫–∞–µ–º create-repo (dry-run)
"$BIN" --dry-run --platform=github || {
  echo "‚ùå create-repo failed on first run"
  exit 1
}

# –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –ø–∞–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞
if ! grep -Fxq "$TMP_DIR" ~/.repo-autosync.list; then
  echo "‚ùå Repo not tracked after first run"
  exit 1
fi

# –ü–æ–ø—Ä–æ–±—É–µ–º –≤—Ç–æ—Ä–æ–π —Ä–∞–∑
"$BIN" --dry-run --platform=github || {
  echo "‚ùå create-repo failed on second run"
  exit 1
}

# –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –Ω–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–∞
COUNT=$(grep -Fx "$TMP_DIR" ~/.repo-autosync.list | wc -l)
if [[ "$COUNT" -gt 1 ]]; then
  echo "‚ùå Path is duplicated in ~/.repo-autosync.list"
  grep -F "$TMP_DIR" ~/.repo-autosync.list
  exit 1
fi

echo "‚úÖ Double tracking test passed"
