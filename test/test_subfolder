#!/bin/bash
set -e
set -x

echo "üß™ Testing subfolder .git corner case..."

BIN="${CREATE_REPO_BIN:-./create-repo}"
TMP_DIR=$(mktemp -d)
cd "$TMP_DIR"
echo "üìÅ TMP_DIR: $TMP_DIR"

mkdir subfolder
cd subfolder
git init -b main &>/dev/null
git config user.email "ci@example.com"
git config user.name "CI User"
echo "# Subfolder .git test" > README.md
git add README.md
git commit -m "init" &>/dev/null
git remote add origin https://example.com/fake.git
cd ..

# –ó–∞–ø—É—Å–∫–∞–µ–º create-repo –≤ –∫–æ—Ä–Ω–µ
"$BIN" --dry-run --platform=github || {
  echo "‚ùå create-repo failed"
  exit 1
}

# –ü—Ä–æ–≤–µ—Ä–∏–º, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ .git –Ω–µ –≤ PWD, –∞ –≤ subfolder
if [ ! -d "$TMP_DIR/subfolder/.git" ]; then
  echo "‚ùå .git not found in subfolder"
  exit 1
fi

# –õ–æ–≥–∏–∫–∞ —Ç–æ–≥–æ, –¥–æ–ª–∂–Ω–æ –ª–∏ create-repo —Ä–µ—à–∏—Ç—å, —á—Ç–æ —ç—Ç–æ "Not a Git repo"
# –∏–ª–∏ —Å—á–∏—Ç–∞—Ç—å subfolder –∑–∞ repo.
# –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–∞—à–µ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è. –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –æ–∂–∏–¥–∞–µ—Ç–µ –æ—à–∏–±–∫—É?
if grep -q "$TMP_DIR" ~/.repo-autosync.list; then
  echo "‚ùå Path was tracked, but .git is in subfolder"
  exit 1
fi

echo "‚úÖ Subfolder .git test passed (repo not tracked)"
